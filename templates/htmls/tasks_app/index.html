{% extends "htmls/base/base_site.html" %}
{% load static %}

{% block title %}Tasks App{% endblock title %}

{% block stylesheets %}
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/bs5/jq-3.3.1/dt-1.10.25/datatables.min.css"/>
{% endblock stylesheets %}

{% block scripts %}
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.1/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/bs5/jq-3.3.1/dt-1.10.25/datatables.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#tasks_table').DataTable();
        });

        function modalOnClick(url, text, status, type) {

            console.log(url)
            console.log(type)
            console.log(text)

            let html;
            let id;
            let label;
            if (type === 1) {
                id = 'editTaskModal'
                label = 'editTaskModalLabel'
                html = `
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTaskModalLabel">Adding New Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    {% if user.is_authenticated %}
                        <form action="`+ url +`"
                                method="post" enctype="multipart/form-data">
                            <div class="modal-body">
                                {% csrf_token %}
                                <label>
                                    Task text
                                    <input type="text" name="task text" size="20" value="` + text + `">
                                </label>
                                <label>
                                    Task status
                                    <input type="text" name="task status" size="20" value="` + status + `">
                                </label>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary">Save changes</button>
                            </div>
                        </form>
                    {% endif %}`;
            } else if (type === 2) {
                id = "addNewTaskModalLabel"
                label = "addNewTaskModalLabel"
                html = `<div class="modal-header">
                        <h5 class="modal-title" id="addNewTaskModalLabel">Adding New Task</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form action="` + url + `" method="post" enctype="multipart/form-data">
                        <div class="modal-body">
                            {% csrf_token %}
                            {{ new_task_form.as_p }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>`;
            }
            let exampleModal = getExampleModal(id);

            // Init the modal if it hasn't been already.
            if (!exampleModal) {
                exampleModal = initExampleModal(id, label);
            }

            setExampleModalContent(html, id);

            // Show the modal.
            jQuery(exampleModal).modal('show');

        }

        function getExampleModal(id) {
            return document.getElementById(id);
        }

        function setExampleModalContent(html, id) {
            getExampleModal(id).querySelector('.modal-content').innerHTML = html;
        }

        function initExampleModal(id, label) {
            var modal = document.createElement('div');
            modal.classList.add('modal', 'fade');
            modal.setAttribute('id', id);
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-labelledby', label);
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML =
                '<div class="modal-dialog" role="document">' +
                '<div class="modal-content"></div>' +
                '</div>';
            document.body.appendChild(modal);
            return modal;
        }


    </script>
{% endblock scripts %}

{% block header %}

    <div class="card-header">
        {% if user.is_authenticated %}
            <div class="float-end">
                {% if user.is_authenticated %}
                    You are logged in as <b>{{ user }}</b>
                    <a href="{% url 'logout' %}" class="btn btn-danger">logout</a>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-primary">login</a>
                {% endif %}
            </div>

            <div>
                <button type="button" class="btn btn-success"
                        onclick="modalOnClick('{% url 'add_task' %}','','', 2)">
                    Add New Task
                </button>
            </div>
        {% endif %}

    </div>
{% endblock header %}

{% block body %}
    <div class="container-fluid p-3">
        <table id="tasks_table" class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>User Name</th>
                <th>Email</th>
                <th>Status</th>
                <th>Text</th>
                <th>Tag</th>
                {% if user.is_authenticated %}
                    <th>Actions</th>{% endif %}
            </tr>
            </thead>
            {% if tasks %}
                <tbody>
                {% for t in tasks %}
                    <tr>
                        <td>{{ t.user_name }}</td>
                        <td>{{ t.email }}</td>
                        <td>{{ t.task_status }}</td>
                        <td>{{ t.task_text }}</td>
                        <td>
                            {% if t.edited_by_admin %}
                                edited by admin
                            {% endif %}
                        </td>
                        {% if user.is_authenticated %}
                            <td>
                                <button type="button" class="btn btn-outline-info"
                                        onclick="modalOnClick('{% url 'edit_task' t.id %}','{{ t.task_text }}','{{ t.task_status }}', 1)">

                                    edit
                                </button>
                                {#                            <a class="btn btn-primary" href="{% url 'edit_task' t.id %}">edit</a>#}
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>

                </table>
            {% else %}
                <p>No tasks available</p>
            {% endif %}


        <div class="modal fade" id="addNewTaskModal" tabindex="-1" aria-labelledby="addNewTaskModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">

                </div>
            </div>
        </div>

    </div>
{% endblock body %}
